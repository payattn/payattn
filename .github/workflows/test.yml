name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: Run tests
        working-directory: backend
        run: npm run test:ci
      
      - name: Debug - List coverage files
        working-directory: backend
        if: always()
        run: |
          echo "=== Checking for coverage directory ==="
          ls -la coverage/ || echo "Coverage directory does not exist"
          echo "=== Looking for coverage-summary.json ==="
          find . -name "coverage-summary.json" || echo "No coverage-summary.json found"
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Check coverage threshold
        working-directory: backend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.branches.pct")
            FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.functions.pct")
            STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.statements.pct")
            
            echo "Coverage Report:"
            echo "  Lines: $LINES%"
            echo "  Branches: $BRANCHES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Statements: $STATEMENTS%"
            
            # Check thresholds: branches/functions 30%, lines/statements 35%
            if (( $(echo "$LINES < 35" | bc -l) )); then
              echo "❌ Lines coverage ($LINES%) is below 35%"
              exit 1
            fi
            if (( $(echo "$BRANCHES < 30" | bc -l) )); then
              echo "❌ Branches coverage ($BRANCHES%) is below 30%"
              exit 1
            fi
            if (( $(echo "$FUNCTIONS < 30" | bc -l) )); then
              echo "❌ Functions coverage ($FUNCTIONS%) is below 30%"
              exit 1
            fi
            if (( $(echo "$STATEMENTS < 35" | bc -l) )); then
              echo "❌ Statements coverage ($STATEMENTS%) is below 35%"
              exit 1
            fi
            
            echo "✅ All coverage metrics meet 35% threshold"
          fi
      
      - name: Upload backend coverage artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: ./backend/coverage/coverage-summary.json
          retention-days: 1

  test-agent:
    name: Advertiser Agent Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: advertiser-agent/package-lock.json
      
      - name: Install dependencies
        working-directory: advertiser-agent
        run: npm ci
      
      - name: Run tests
        working-directory: advertiser-agent
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key
          VENICE_API_KEY: test-venice-key
          SOLANA_RPC_URL: https://api.devnet.solana.com
        run: npm run test:coverage
      
      - name: Debug - List agent coverage files
        working-directory: advertiser-agent
        if: always()
        run: |
          echo "=== Checking for coverage directory ==="
          ls -la coverage/ || echo "Coverage directory does not exist"
          echo "=== Looking for coverage-summary.json ==="
          find . -name "coverage-summary.json" || echo "No coverage-summary.json found"
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./advertiser-agent/coverage/lcov.info
          flags: agent
          name: agent-coverage
          fail_ci_if_error: false
      
      - name: Check coverage threshold
        working-directory: advertiser-agent
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.branches.pct")
            FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.functions.pct")
            STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.statements.pct")
            
            echo "Coverage Report:"
            echo "  Lines: $LINES%"
            echo "  Branches: $BRANCHES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Statements: $STATEMENTS%"
            
            # Check if any metric is below 15%
            if (( $(echo "$LINES < 15" | bc -l) )); then
              echo "❌ Lines coverage $LINES% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$BRANCHES < 15" | bc -l) )); then
              echo "❌ Branches coverage $BRANCHES% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$FUNCTIONS < 15" | bc -l) )); then
              echo "❌ Functions coverage $FUNCTIONS% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$STATEMENTS < 15" | bc -l) )); then
              echo "❌ Statements coverage $STATEMENTS% is below 15% threshold"
              exit 1
            fi
            
            echo "✅ All coverage metrics meet 15% threshold"
          fi
      
      - name: Upload agent coverage artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: agent-coverage
          path: ./advertiser-agent/coverage/coverage-summary.json
          retention-days: 1

  coverage-badge:
    name: Generate Coverage Badge
    runs-on: ubuntu-latest
    needs: [test-backend, test-agent]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage
      
      - name: Download agent coverage
        uses: actions/download-artifact@v4
        with:
          name: agent-coverage
          path: agent-coverage
      
      - name: Generate coverage summary
        run: |
          # Extract coverage percentages from downloaded artifacts
          BACKEND_FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('backend-coverage/coverage-summary.json')).total.functions.pct")
          BACKEND_LINES=$(node -pe "JSON.parse(require('fs').readFileSync('backend-coverage/coverage-summary.json')).total.lines.pct")
          BACKEND_STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('backend-coverage/coverage-summary.json')).total.statements.pct")
          BACKEND_BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('backend-coverage/coverage-summary.json')).total.branches.pct")
          
          AGENT_FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('agent-coverage/coverage-summary.json')).total.functions.pct")
          AGENT_LINES=$(node -pe "JSON.parse(require('fs').readFileSync('agent-coverage/coverage-summary.json')).total.lines.pct")
          AGENT_STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('agent-coverage/coverage-summary.json')).total.statements.pct")
          AGENT_BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('agent-coverage/coverage-summary.json')).total.branches.pct")
          
          # Calculate weighted average (70% backend, 30% agent)
          OVERALL_FUNCTIONS=$(node -pe "Math.round(($BACKEND_FUNCTIONS * 0.7 + $AGENT_FUNCTIONS * 0.3) * 100) / 100")
          OVERALL_LINES=$(node -pe "Math.round(($BACKEND_LINES * 0.7 + $AGENT_LINES * 0.3) * 100) / 100")
          OVERALL_STATEMENTS=$(node -pe "Math.round(($BACKEND_STATEMENTS * 0.7 + $AGENT_STATEMENTS * 0.3) * 100) / 100")
          OVERALL_BRANCHES=$(node -pe "Math.round(($BACKEND_BRANCHES * 0.7 + $AGENT_BRANCHES * 0.3) * 100) / 100")
          
          # Create standard coverage JSON for shields.io dynamic badge
          cat > coverage.json << EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${OVERALL_FUNCTIONS}%",
            "color": "$(
              if (( $(echo "$OVERALL_FUNCTIONS >= 80" | bc -l) )); then
                echo "brightgreen"
              elif (( $(echo "$OVERALL_FUNCTIONS >= 60" | bc -l) )); then
                echo "green"
              elif (( $(echo "$OVERALL_FUNCTIONS >= 40" | bc -l) )); then
                echo "yellow"
              elif (( $(echo "$OVERALL_FUNCTIONS >= 20" | bc -l) )); then
                echo "orange"
              else
                echo "red"
              fi
            )"
          }
          EOF
          
          echo "Generated coverage.json with ${OVERALL_FUNCTIONS}% function coverage"
      
      - name: Commit coverage badge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage.json
          git diff --staged --quiet || git commit -m "Update coverage badge [skip ci]"
          git push

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-backend, test-agent]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-backend.result }}" == "success" ] && [ "${{ needs.test-agent.result }}" == "success" ]; then
            echo "✅ All tests passed!"
            exit 0
          else
            echo "❌ Some tests failed"
            echo "Backend: ${{ needs.test-backend.result }}"
            echo "Agent: ${{ needs.test-agent.result }}"
            exit 1
          fi
