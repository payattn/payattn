name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: Run tests
        working-directory: backend
        run: npm run test:ci
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Check coverage threshold
        working-directory: backend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.branches.pct")
            FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.functions.pct")
            STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.statements.pct")
            
            echo "Coverage Report:"
            echo "  Lines: $LINES%"
            echo "  Branches: $BRANCHES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Statements: $STATEMENTS%"
            
            # Check if any metric is below 35%
            if (( $(echo "$LINES < 35" | bc -l) )); then
              echo "❌ Lines coverage $LINES% is below 35% threshold"
              exit 1
            fi
            if (( $(echo "$BRANCHES < 35" | bc -l) )); then
              echo "❌ Branches coverage $BRANCHES% is below 35% threshold"
              exit 1
            fi
            if (( $(echo "$FUNCTIONS < 35" | bc -l) )); then
              echo "❌ Functions coverage $FUNCTIONS% is below 35% threshold"
              exit 1
            fi
            if (( $(echo "$STATEMENTS < 35" | bc -l) )); then
              echo "❌ Statements coverage $STATEMENTS% is below 35% threshold"
              exit 1
            fi
            
            echo "✅ All coverage metrics meet 35% threshold"
          fi

  test-agent:
    name: Advertiser Agent Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: advertiser-agent/package-lock.json
      
      - name: Install dependencies
        working-directory: advertiser-agent
        run: npm ci
      
      - name: Run tests
        working-directory: advertiser-agent
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key
          VENICE_API_KEY: test-venice-key
          SOLANA_RPC_URL: https://api.devnet.solana.com
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./advertiser-agent/coverage/lcov.info
          flags: agent
          name: agent-coverage
          fail_ci_if_error: false
      
      - name: Check coverage threshold
        working-directory: advertiser-agent
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            BRANCHES=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.branches.pct")
            FUNCTIONS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.functions.pct")
            STATEMENTS=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.statements.pct")
            
            echo "Coverage Report:"
            echo "  Lines: $LINES%"
            echo "  Branches: $BRANCHES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Statements: $STATEMENTS%"
            
            # Check if any metric is below 15%
            if (( $(echo "$LINES < 15" | bc -l) )); then
              echo "❌ Lines coverage $LINES% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$BRANCHES < 15" | bc -l) )); then
              echo "❌ Branches coverage $BRANCHES% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$FUNCTIONS < 15" | bc -l) )); then
              echo "❌ Functions coverage $FUNCTIONS% is below 15% threshold"
              exit 1
            fi
            if (( $(echo "$STATEMENTS < 15" | bc -l) )); then
              echo "❌ Statements coverage $STATEMENTS% is below 15% threshold"
              exit 1
            fi
            
            echo "✅ All coverage metrics meet 15% threshold"
          fi

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-backend, test-agent]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-backend.result }}" == "success" ] && [ "${{ needs.test-agent.result }}" == "success" ]; then
            echo "✅ All tests passed!"
            exit 0
          else
            echo "❌ Some tests failed"
            echo "Backend: ${{ needs.test-backend.result }}"
            echo "Agent: ${{ needs.test-agent.result }}"
            exit 1
          fi
