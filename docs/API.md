# API Reference

**PayAttn Backend API Documentation**

---

## üåê Base URL

- **Development:** `http://localhost:3000`
- **Production:** TBD

---

## üîë Authentication

Currently, most endpoints are **unauthenticated** for development. Production will use:
- Solana wallet signature authentication for user endpoints
- API keys for advertiser endpoints

---

## üìç Endpoints

### Proof Verification

#### `POST /api/verify-proof`

Verify a ZK-SNARK proof generated by the extension.

**Request:**
```json
{
  "circuitName": "range_check",
  "proof": {
    "pi_a": ["17277...", "15719...", "1"],
    "pi_b": [
      ["60615...", "83593..."],
      ["21482...", "67754..."],
      ["1", "0"]
    ],
    "pi_c": ["52069...", "13035...", "1"],
    "protocol": "groth16",
    "curve": "bn128"
  },
  "publicSignals": ["1", "25000", "50000"],
  "timestamp": 1762429784939,
  "version": "1.0"
}
```

**Response (Success):**
```json
{
  "valid": true,
  "circuitName": "range_check",
  "publicSignals": ["1", "25000", "50000"],
  "message": "Proof verified successfully",
  "timestamp": 1762429785000,
  "verificationTime": 47
}
```

**Response (Invalid Proof):**
```json
{
  "valid": false,
  "circuitName": "range_check",
  "publicSignals": ["1", "25000", "50000"],
  "message": "Proof verification failed",
  "timestamp": 1762429785000,
  "verificationTime": 52
}
```

**Response (Error):**
```json
{
  "error": "Invalid circuit name",
  "code": "INVALID_CIRCUIT",
  "timestamp": 1762429785000
}
```

**Circuit Names:**
- `range_check` - Generic range proof
- `age_range` - Age-specific range proof
- `set_membership` - Set membership proof

**Performance:**
- Average: 30-100ms
- Timeout: 5 seconds

---

#### `POST /api/verify-proof` (Batch)

Verify multiple proofs in a single request.

**Request:**
```json
{
  "proofs": [
    {
      "circuitName": "range_check",
      "proof": { /* proof object */ },
      "publicSignals": ["1", "25000", "50000"]
    },
    {
      "circuitName": "age_range",
      "proof": { /* proof object */ },
      "publicSignals": ["1", "18", "65"]
    }
  ]
}
```

**Response:**
```json
{
  "results": [
    {
      "valid": true,
      "circuitName": "range_check",
      "verificationTime": 47
    },
    {
      "valid": true,
      "circuitName": "age_range",
      "verificationTime": 52
    }
  ],
  "totalTime": 105,
  "allValid": true
}
```

---

### Key-Derivation Storage

#### `GET /api/k/{hash}`

Retrieve stored data by hash (for key-derivation based storage).

**Request:**
```
GET /api/k/6be513a44eab80aca2224f8df013e0179e362f40049c82c10eabe478361ebf28
Headers:
  x-wallet-address: Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s
  x-auth-token: <base64-signature>
```

**Response (Success):**
```json
{
  "data": {
    "campaigns": [...],
    "preferences": {...}
  },
  "hash": "6be513a44eab...",
  "timestamp": 1762429785000
}
```

**Response (Not Found):**
```json
{
  "error": "Data not found",
  "code": "NOT_FOUND",
  "hash": "6be513a44eab..."
}
```

**Authentication:**
- Required: `x-wallet-address` and `x-auth-token` headers
- Token is Solana wallet signature of message

---

#### `PUT /api/k/{hash}`

Store data by hash.

**Request:**
```json
{
  "data": {
    "campaigns": [...],
    "preferences": {...}
  }
}

Headers:
  x-wallet-address: Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s
  x-auth-token: <base64-signature>
```

**Response:**
```json
{
  "success": true,
  "hash": "6be513a44eab...",
  "timestamp": 1762429785000
}
```

---

### Dashboard Pages

#### `GET /advertisers`

Advertiser dashboard (HTML page).

**Response:** HTML page with campaign management interface

---

#### `GET /dashboard`

User dashboard (HTML page).

**Response:** HTML page with proof generation interface

---

## Authentication Details

### Solana Wallet Authentication

**Message Format:**
```
Sign in to Pay Attention

Wallet: {walletAddress}
```

**Signature Generation (Extension):**
```javascript
const message = `Sign in to Pay Attention\n\nWallet: ${walletAddress}`;
const messageBytes = new TextEncoder().encode(message);
const signature = await wallet.signMessage(messageBytes);
const authToken = base64.encode(signature);
```

**Verification (Backend):**
```typescript
const message = `Sign in to Pay Attention\n\nWallet: ${walletAddress}`;
const messageBytes = new TextEncoder().encode(message);
const signatureBytes = base64.decode(authToken);
const publicKey = new PublicKey(walletAddress);
const verified = nacl.sign.detached.verify(
  messageBytes,
  signatureBytes,
  publicKey.toBytes()
);
```

---

## Response Codes

| Code | Meaning |
|------|---------|
| 200 | Success |
| 400 | Bad Request (invalid input) |
| 401 | Unauthorized (invalid/missing auth) |
| 404 | Not Found |
| 500 | Internal Server Error |
| 503 | Service Unavailable (verification timeout) |

---

## üö® Error Codes

### Verification Errors

| Code | Description |
|------|-------------|
| `INVALID_CIRCUIT` | Circuit name not recognized |
| `INVALID_PROOF` | Proof format invalid |
| `INVALID_SIGNALS` | Public signals format invalid |
| `VERIFICATION_FAILED` | Proof verification returned false |
| `VERIFICATION_TIMEOUT` | Verification took >5 seconds |
| `MISSING_VKEY` | Verification key file not found |
| `RAPIDSNARK_ERROR` | Rapidsnark binary execution failed |

### Storage Errors

| Code | Description |
|------|-------------|
| `NOT_FOUND` | Hash not in storage |
| `UNAUTHORIZED` | Invalid wallet signature |
| `INVALID_HASH` | Hash format invalid |
| `STORAGE_ERROR` | Database/storage failure |

---

## üìè Rate Limits

**Current (Development):** No rate limits

**Planned (Production):**
- Proof verification: 100 requests/minute per IP
- Storage: 1000 requests/hour per wallet

---

## Request Examples

### cURL Examples

**Verify Proof:**
```bash
curl -X POST http://localhost:3000/api/verify-proof \
  -H "Content-Type: application/json" \
  -d '{
    "circuitName": "range_check",
    "proof": {
      "pi_a": ["17277822615039882201490351104284389265503421995091964199327971287058730132775", "15719361547713695247921272572415650211090959371693413954614501879916553345325", "1"],
      "pi_b": [["606155355846146389652022574741401545738347019617341974183210585374422612309", "8359395395419202274180340148629366215717183678482486358178049557355924524033"], ["21482277653163887734128301689510488742777134544521404791827598487531490701026", "6775436853291467666093363498807278197726602496939124271403085161313054082429"], ["1", "0"]],
      "pi_c": ["5206906585847239001991161025537116348795681638279121463779164851019247124558", "13035629333049980711812692765035746104532767559111478827256444406566843125279", "1"],
      "protocol": "groth16",
      "curve": "bn128"
    },
    "publicSignals": ["1", "25000", "50000"]
  }'
```

**Get Storage:**
```bash
curl -X GET http://localhost:3000/api/k/6be513a44eab80aca2224f8df013e0179e362f40049c82c10eabe478361ebf28 \
  -H "x-wallet-address: Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s" \
  -H "x-auth-token: <base64-signature>"
```

### JavaScript Examples

**Extension (Proof Generation + Verification):**
```javascript
// Generate proof
const { proof, publicSignals } = await generateProof('range_check', {
  value: 35,
  min: 25,
  max: 50
});

// Send to backend
const response = await fetch('http://localhost:3000/api/verify-proof', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    circuitName: 'range_check',
    proof,
    publicSignals
  })
});

const result = await response.json();
console.log('Proof valid:', result.valid);
```

---

## Implementation Details

### Backend Code Structure

```
agent-dashboard/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ verify-proof/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts          # POST /api/verify-proof
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ k/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ [hash]/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ route.ts      # GET/PUT /api/k/{hash}
‚îÇ   ‚îú‚îÄ‚îÄ advertisers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx              # GET /advertisers
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx              # GET /dashboard
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ zk/
        ‚îú‚îÄ‚îÄ verifier.ts           # Rapidsnark integration
        ‚îî‚îÄ‚îÄ circuits-registry.ts  # Circuit metadata
```

### Verification Flow (Internal)

```typescript
// app/api/verify-proof/route.ts
export async function POST(request: Request) {
  const body = await request.json();
  
  // Call verifier
  const result = await verifyProof(
    body.circuitName,
    body.proof,
    body.publicSignals
  );
  
  return Response.json(result);
}

// lib/zk/verifier.ts
export async function verifyProof(
  circuitName: string,
  proof: any,
  publicSignals: string[]
): Promise<VerificationResult> {
  // 1. Write temp files
  const tempDir = path.join(tmpdir(), `zk-verify-${Date.now()}`);
  fs.mkdirSync(tempDir, { recursive: true });
  fs.writeFileSync(proofPath, JSON.stringify(proof));
  fs.writeFileSync(publicPath, JSON.stringify(publicSignals));
  
  // 2. Execute Rapidsnark
  const { stderr } = await execAsync(
    `"${RAPIDSNARK_VERIFIER}" "${vkeyPath}" "${publicPath}" "${proofPath}"`,
    { timeout: 5000 }
  );
  
  // 3. Parse result
  const isValid = stderr.includes('Valid proof');
  
  // 4. Cleanup
  fs.rmSync(tempDir, { recursive: true, force: true });
  
  return {
    valid: isValid,
    circuitName,
    publicSignals,
    message: isValid ? 'Proof verified successfully' : 'Proof verification failed',
    timestamp: Date.now(),
    verificationTime
  };
}
```

---

## Testing

See [TESTING.md](./TESTING.md) for detailed testing procedures.

**Quick test:**
```bash
# Generate proof in extension, then:
curl -X POST http://localhost:3000/api/verify-proof \
  -H "Content-Type: application/json" \
  -d @proof.json
```

---

## Notes

### Why POST for Verification?

ZK-SNARK proofs are ~1KB of JSON data, too large for GET query parameters. POST allows proper JSON body.

### Why No Batch Endpoint in V1?

Keeping it simple for MVP. Most use cases verify one proof at a time. Batch support can be added if needed.

### Why Store by Hash?

Key-derivation based storage allows privacy-preserving data retrieval without traditional accounts/databases.

---

## Related Documents

- [ARCHITECTURE.md](./ARCHITECTURE.md) - System overview
- [ZK_PROOF_FLOW.md](./ZK_PROOF_FLOW.md) - Proof lifecycle
- [BACKEND_VERIFICATION.md](./BACKEND_VERIFICATION.md) - Rapidsnark details

---

**Last Updated:** November 6, 2025  
**API Version:** 1.0
