#!/usr/bin/env node

/**
 * Seed Test Offers for Peggy Testing
 * 
 * Creates test offers with status='offer_made' for Peggy to evaluate
 * Uses advertiser wallet: AE6uwbubDn9WyXrpzvqU58jfirvqZAxWCZCfDDwW5MMb
 */

const { createClient } = require('@supabase/supabase-js');
const { readFileSync } = require('fs');
const { join } = require('path');

// Load environment variables from .env.local
const envPath = join(__dirname, '../.env.local');
try {
  const envFile = readFileSync(envPath, 'utf8');
  envFile.split('\n').forEach(line => {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key && valueParts.length > 0) {
        process.env[key.trim()] = valueParts.join('=').trim();
      }
    }
  });
} catch (error) {
  console.error('Warning: Could not load .env.local:', error.message);
}

// Read from environment variables (should be set by Next.js or manually)
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

console.log('[Seed] Checking environment variables...');
console.log(`  NEXT_PUBLIC_SUPABASE_URL: ${supabaseUrl ? '‚úì' : '‚úó'}`);
console.log(`  Supabase Key: ${supabaseKey ? '‚úì' : '‚úó'}\n`);

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Missing Supabase credentials in environment variables');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Advertiser wallet (Peggy's wallet)
const ADVERTISER_WALLET = 'AE6uwbubDn9WyXrpzvqU58jfirvqZAxWCZCfDDwW5MMb';

// Test offers data
const TEST_OFFERS = [
  {
    offer_id: 'offer_test_booking_001',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_001',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_travel_booking_001',
    amount_lamports: 156250,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['3991241326258154294640618433363239125435376661701488748474472160170021108532', '18359051368785418776606694780981333004236462780244037029204380043323124795152', '1'],
          pi_b: [['4985701347436006540925479823043422202824627365079008255187023820124741218590', '11266826511794202258601884761661559730014439448660216636218641246937421869573'], ['12802623560197002522015136476557138784566856229177127549423612581042302675230', '6470031583079863072826918212389184327040222967868162886400749387537351330607'], ['1', '0']],
          pi_c: ['19596708393640231336057869041225106659186247410308460720202885738750883306684', '20601188657890462836923657206203921370215865548969824838679414916910150237459', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '25', '60']
      },
      location: {
        proof: {
          pi_a: ['20199456689710239684089300110520178111408616369516946283477523608459151928794', '20149023338826764627662516083237111614260515663758512941400376302098998812952', '1'],
          pi_b: [['8876684662543776874732092542865208677623455766793735315957636194242146383165', '3465494452538237487132148710777763590029938233504175200061224093011488047811'], ['21401526132874421054756682057893792158100803620805680580932778499812664090331', '11227060464270954425991121163274676963538424987290833405083909269894764310305'], ['1', '0']],
          pi_c: ['17860717734490620720798304122252940667943178627629675320499777101797167548366', '563802677072744525568869454433608248199989931211313453215325027834723537894', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['1', '2710', '2718', '2142', '2100', '2177', '2252', '2222', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_nike_001',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_002',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_fashion_shoes_001',
    amount_lamports: 75000,
    status: 'offer_made',
    zk_proofs: {
      location: {
        proof: {
          pi_a: ['16882653676214555866524516732665667726948172384470268872687703264666622898187', '18201776464591187649882409271005827385675159022955464265188518546770731433654', '1'],
          pi_b: [['6286460410551279434078688430969940298815501244496641540750623433083352698588', '11376893647725568210605842607278557821638693416044099787196328463352426632987'], ['19281475499459113035514654263986706302720455856110937205770737974397959019591', '17055638698436700389993778942946450162467537828539212289653879206243508676678'], ['1', '0']],
          pi_c: ['15870700507281314742316541697415252785960054481048518796305028377895039214904', '8988606945849817526096254500994220697487349363217267455124997055833219949053', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['1', '2718', '2710', '2142', '2252', '2177', '0', '0', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_vpn_001',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_003',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_vpn_security_001',
    amount_lamports: 137499,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['18809514084773406877479915475203829917580649997778560008074930669005675081400', '11009292898506593366839886849824105654967014931744544896853772203361711836290', '1'],
          pi_b: [['19516838126628622645765978627218057912935963237845737962221540504621121276219', '6983606232668137108929906013901574300148599593517952750073248688748009887662'], ['18535133744597683689338974446922842222974890674323588083132946608580000414127', '12915866415455252538247245354385684091756204484121072459541327274076751327390'], ['1', '0']],
          pi_c: ['16585808531592158228828030248420567726738516624325083745864546049750429649524', '12586049339534442790138155707314856329321072776025819764320509012338967914909', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '25', '55']
      },
      location: {
        proof: {
          pi_a: ['3467185951343307835881544574682258566092046885466301452500443694332294301368', '16334773640095119393052240554079333623865621005678453035510995081433746912169', '1'],
          pi_b: [['17157995834403886670934555845293208369432103951951051853101617286922052665014', '10993204925462047037257831849354439428984577518123039877015538454131202871969'], ['14395307929944395885563602000234054991176923421762492040762505579742294409366', '15754763414734235128354463996206115516105064526301530619921665397127498988758'], ['1', '0']],
          pi_c: ['605553896261838741704548339757115166498604974883400614409525373180056047002', '1918224718440300147677163821841771801588634244205371015184730118001205413855', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['1', '2718', '2710', '2142', '2100', '2177', '2252', '0', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_trading_001',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_004',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_investment_app_001',
    amount_lamports: 218750,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['21744204155130494378482594015915856244994377278881899617369468560148791819585', '18110494265671142732353176478003022795608946443703383193511281083566879184742', '1'],
          pi_b: [['4816384135904573598297767340254965833572627554559977441096880534211449839490', '20473403668782837692028100886925187006121737947307552371227341446271621035480'], ['746612649176139644932082435166865826495156727239697113215439446816487311651', '18642294557999495886715083868211597783285287818247837025649246397545008159357'], ['1', '0']],
          pi_c: ['5512758456727847400088320502125619925116266156829304289611688517351918031730', '5971140654325445286456539901137364225895398597645834698533360036164094908633', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '21', '45']
      },
      location: {
        proof: {
          pi_a: ['2028073215401134424434226544001306229745097209747214765131331521998387923494', '10315842841292241892603281105641453363091720805706881096523271300229906273407', '1'],
          pi_b: [['11289786850067546579354362442776733209242829719491065734367784699976111670943', '21480727369312797789435698680788509583765806554934893080212448383049294530991'], ['21678950615575305766380102052557760291371736416072307815281229227575594871551', '7517516962218324046384933025286214084297575800690619574650940955392789335339'], ['1', '0']],
          pi_c: ['21421748429308276378083409642112188767993099110740629956648712394725195030697', '8119476552532691393296367415916429922938080468516237055641977898103927884999', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['0', '2710', '2224', '0', '0', '0', '0', '0', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_vpn_002',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_005',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_vpn_security_001',
    amount_lamports: 125000,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['5250037510130280411124553974187369901311676517697841942091635550515025688476', '19059297487301564324146211596684059994605278037166305300490541410667987461477', '1'],
          pi_b: [['18348202801201683853278593044616614676419321740041155815802305025723240053217', '16426293616094909740277344122004104314675004996871173288526150574970245158258'], ['21627412070185928659918450534292689821224113104312635730021984777328692815352', '8929946863075984137804728357848345049457968053985571169058254895407162975736'], ['1', '0']],
          pi_c: ['18500533083257885949465905946614530767369599616326885705523122406971137911133', '20765905223130576511555469684843184844845191155725323649742761595609650750071', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '25', '55']
      },
      location: {
        proof: {
          pi_a: ['10085570132128309116531914424782683183683522787627867751708213650347711344313', '5069148514425245177500370107428005516690804166636677726665963404173697635696', '1'],
          pi_b: [['20020641038482558134585703292848527755728917960300974191784132986018720395743', '18234196801517374798995501035769691107079611299540214273256410203844078634004'], ['2145797424203531854680479953693626129652341548181489621431349767664713633815', '20470649033751005824947666705903313504962706772906407254837317563364560368648'], ['1', '0']],
          pi_c: ['8721883545837828477818536001550139030780151849218390387891485689785990029769', '8796538625322957579809835983714253512234566106749587289314675103476760832662', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['1', '2718', '2710', '2142', '2100', '2177', '2252', '0', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_booking_002',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_006',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_travel_booking_001',
    amount_lamports: 281250,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['19950616931233441583224402085180196389424019065611640928909570339808386580288', '19355255132479875534822928679988715087734124671357708268382041208640119500493', '1'],
          pi_b: [['21673835660023266791648851757094547463337079680070482588985957948761970295663', '16995028929154517899924594862517285390839262408459324356962978500355487431189'], ['2548548221973893287744135419244703685130268154420045762096742344114066058662', '9579403370314627344940156714694432671355243420676506873090435401390443289025'], ['1', '0']],
          pi_c: ['2544929350036705144638559677026957089512384493840232928531597544972660724210', '14674562687107708265575901598831529036715007539837011518676478394471680064354', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '25', '60']
      },
      location: {
        proof: {
          pi_a: ['19162220557251454890169240983375150145784106580625398780946400920377524161419', '10217554842339524040816749737236696781661333742936759285094975096680520256775', '1'],
          pi_b: [['6490567108199660712011091069824030193596506098985545875644862013482204425074', '8609072583303535692538301166938257262541889613986143307039795942162565425347'], ['5511638080014377382071889426542223782088919589505647560785460799320373895115', '5029998662874389645669750960044446534514044770394484935436515709824448395724'], ['1', '0']],
          pi_c: ['5388277543686950862551013560436424061053655376052219309053671467568428662113', '8148271751567896150428810828000480043520842473962582512702762278507615242061', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['1', '2710', '2718', '2142', '2100', '2177', '2252', '2222', '0', '0', '0']
      }
    }
  },
  {
    offer_id: 'offer_test_trading_002',
    advertiser_id: ADVERTISER_WALLET,
    user_id: 'user_test_007',
    user_pubkey: 'Aiv9yEcriCQzE8YZu6sRopDzHw2ZgDzCWidAXaruwe7s',
    ad_id: 'test_investment_app_001',
    amount_lamports: 200000,
    status: 'offer_made',
    zk_proofs: {
      age: {
        proof: {
          pi_a: ['1485465776626669642730120176132760213522481559314088220743925283927245621820', '20544284010744185481439427473206821431499966607396158914363312962539064152528', '1'],
          pi_b: [['16344054227201785058933890397289115301524361610484041814185616406929301280424', '21363245962404692585842578689585812240655404126541156013106864342634840214276'], ['12582641844121106847197514687013059754015343782555547368464613498247810913915', '5846288130413359263204226762013900987631764756549973777075996749287217869260'], ['1', '0']],
          pi_c: ['2487444701055455206697503572924355469568089361681935210846764636465571008872', '15144241630500920748491491769274136362331029103485133107894629854767306333282', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'range_check',
        publicSignals: ['1', '21', '45']
      },
      location: {
        proof: {
          pi_a: ['4043525812620080733036689145189648138850731169759252652795684859997151781630', '10329123007228502360975553533420977194934949089176694984297805675566620566921', '1'],
          pi_b: [['10925454072083187978160676519484275748457523130819138697221918879201530122144', '4026374892240293414316276425550156700297835049413376406837243327021964459180'], ['5683663025334621953951643123838902021474782166363890015854663009981561339682', '13474673876594367424991531789842574980057091690078490497957464279729281227607'], ['1', '0']],
          pi_c: ['13027028399359367424991531789842574980057091690078490497957464279729281227195', '1049060757439080925047805119388027295916627788293401416151025115338530421873', '1'],
          curve: 'bn128',
          protocol: 'groth16'
        },
        circuitName: 'set_membership',
        publicSignals: ['0', '2710', '2224', '0', '0', '0', '0', '0', '0', '0', '0']
      }
    }
  }
];

async function seedOffers() {
  console.log('üå± Seeding test offers for Peggy...');
  console.log(`Advertiser: ${ADVERTISER_WALLET}\n`);

  try {
    // Insert offers
    for (const offer of TEST_OFFERS) {
      console.log(`Creating offer: ${offer.offer_id}`);
      console.log(`  Ad: ${offer.ad_id}`);
      console.log(`  Amount: ${offer.amount_lamports} lamports (${(offer.amount_lamports / 1e9).toFixed(6)} SOL)`);
      console.log(`  ZK Proofs: ${Object.keys(offer.zk_proofs).join(', ')}`);

      const { error } = await supabase
        .from('offers')
        .insert({
          offer_id: offer.offer_id,
          advertiser_id: offer.advertiser_id,
          user_id: offer.user_id,
          user_pubkey: offer.user_pubkey,
          ad_id: offer.ad_id,
          amount_lamports: offer.amount_lamports,
          status: offer.status,
          zk_proofs: offer.zk_proofs,
          gas_fees_lamports: 15000
        });

      if (error) {
        // If already exists, skip
        if (error.code === '23505') {
          console.log(`  ‚ö†Ô∏è  Already exists, skipping\n`);
        } else {
          throw error;
        }
      } else {
        console.log(`  ‚úÖ Created\n`);
      }
    }

    console.log('‚úÖ Seeding complete!');
    console.log(`\nüìä Summary:`);
    console.log(`  Total offers created: ${TEST_OFFERS.length}`);
    console.log(`  Status: 'offer_made' (ready for Peggy)`);
    console.log(`  Advertiser: ${ADVERTISER_WALLET}`);
    
    console.log(`\nü§ñ Next steps:`);
    console.log(`  1. Run Peggy: cd advertiser-agent && npm start`);
    console.log(`  2. Or use manual UI: http://localhost:3000/advertisers/offer-queue`);
    console.log(`  3. Check database: SELECT * FROM offers WHERE advertiser_id = '${ADVERTISER_WALLET}';`);

  } catch (error) {
    console.error('‚ùå Seeding failed:', error);
    process.exit(1);
  }
}

async function cleanOffers() {
  console.log('üßπ Cleaning test offers...');
  
  try {
    const { error } = await supabase
      .from('offers')
      .delete()
      .eq('advertiser_id', ADVERTISER_WALLET);

    if (error) throw error;

    console.log('‚úÖ Test offers cleaned!');
  } catch (error) {
    console.error('‚ùå Cleaning failed:', error);
    process.exit(1);
  }
}

// Parse command line arguments
const args = process.argv.slice(2);
const shouldClean = args.includes('--clean');

if (shouldClean) {
  cleanOffers();
} else {
  seedOffers();
}
